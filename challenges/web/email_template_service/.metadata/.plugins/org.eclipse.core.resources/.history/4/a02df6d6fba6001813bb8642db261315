package application;

import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.Map;

import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.sqlite.SQLiteConfig;
import org.thymeleaf.TemplateEngine;
import org.thymeleaf.templatemode.TemplateMode;
import org.thymeleaf.templateresolver.StringTemplateResolver;

@Controller
public class PageController {
	private TemplateEngine templateEngine;
	private Connection connection;
	
	public PageController() {
		StringTemplateResolver templateResolver = new StringTemplateResolver();
		templateResolver.setTemplateMode(TemplateMode.HTML);
		templateEngine = new TemplateEngine();
		templateEngine.setTemplateResolver(templateResolver);
		
		try {
			PrintWriter writer = new PrintWriter("the-file-name.txt", "UTF-8");
			writer.println("The first line");
			writer.println("The second line");
			writer.close();
		}
		
		SQLiteConfig config = new SQLiteConfig();
		config.setReadOnly(true);
		String url = "jdbc:sqlite:templates.db";
		
		try {
			Connection connection = DriverManager.getConnection(url, config.toProperties());
			if(connection != null) {
				this.connection = connection;
				DatabaseMetaData meta = connection.getMetaData();
			}
		} catch(SQLException e) {
			System.err.println(e.getMessage());
		}
	}
	
	@GetMapping("/")
	public String renderPage(@RequestParam(name="page", required=false, defaultValue="") String page,
			@RequestParam(name = "type", required=false, defaultValue="") String type,
			Model model,
			@RequestParam Map<String,String> allRequestParams) {
		if(page.equals("") && type.equals("")) {
			return "<html><head><meta http-equiv=\"Refresh\" content=\"0; url=/?type=content&page=index\" /></head></html>";
		}
		
		String html;
		
		try {
			ResultSet rs = connection.createStatement().executeQuery("SELECT html FROM templates WHERE name='" + page +
					"' AND type='" + type + "'");
			html = rs.getString("html");
		} catch(SQLException e) {
			System.err.println(e.getMessage());
			return "<html><head><meta http-equiv=\"Refresh\" content=\"0; url=/?type=content&page=index\" /></head></html>";
		}
		
		return html;
	}
}
